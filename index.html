<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cartão NFC — Editor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .card-preview { max-width: 420px; }
    .rounded-circle { border-radius: 9999px; overflow: hidden; }
    .small-icon { width:26px; height:26px; object-fit:cover; border-radius:6px; }
    .service-slide { width:100%; height:150px; display:flex;align-items:center;justify-content:center;background:#fff;border-radius:8px; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen p-6">
  <div class="max-w-6xl mx-auto grid md:grid-cols-3 gap-6">

    <!-- EDITOR -->
    <div class="md:col-span-2 bg-white p-6 rounded-xl shadow">
      <div class="flex items-center justify-between mb-4">
        <h1 class="text-xl font-semibold">Editor — Cartão NFC (Taggy-like)</h1>
        <div class="text-sm text-gray-500">Salvar automático → Firestore</div>
      </div>

      <!-- Cartão ID / controles -->
      <div class="mb-4 flex gap-2">
        <input id="cardId" placeholder="ID do cartão (ex: cartao1)" class="border p-2 rounded flex-1" />
        <button id="btnOpen" class="px-4 py-2 bg-indigo-600 text-white rounded">Abrir / Criar</button>
        <button id="btnList" class="px-3 py-2 border rounded">Listar</button>
      </div>

      <!-- Editor UI -->
      <div id="editorUI" class="space-y-4 opacity-50 pointer-events-none">

        <!-- Fundo e logo -->
        <div class="grid md:grid-cols-3 gap-3 items-center">
          <div class="md:col-span-2">
            <label class="text-xs text-gray-600">Imagem de fundo (arraste/selecionar)</label>
            <input id="bgFile" type="file" accept="image/*" class="w-full border p-2 rounded" />
            <div class="flex items-center gap-2 mt-2">
              <label class="text-xs">Opacidade</label>
              <input id="bgOpacity" type="range" min="0" max="1" step="0.05" value="0.25" />
              <span id="bgOpacityVal" class="text-xs text-gray-500">0.25</span>
            </div>
          </div>
          <div class="flex flex-col items-center gap-2">
            <label class="text-xs text-gray-600">Logo (redonda)</label>
            <input id="logoFile" type="file" accept="image/*" class="border p-2 rounded" />
            <div id="logoPreview" class="w-28 h-28 rounded-circle bg-gray-100 flex items-center justify-center text-sm text-gray-400">Logo</div>
          </div>
        </div>

        <!-- Botões dinâmicos -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-medium">Botões</h2>
            <button id="addBtn" class="px-3 py-1 border rounded text-sm">+ Adicionar botão</button>
          </div>
          <div id="buttonsList" class="space-y-2"></div>
          <div class="text-xs text-gray-500 mt-2">Cada botão pode ter mini-ícone, texto e link. Você pode adicionar/remover/renomear.</div>
        </div>

        <!-- Dados de contato -->
        <div class="grid md:grid-cols-2 gap-3">
          <input id="contactName" placeholder="Nome (contato)" class="border p-2 rounded" />
          <input id="contactCompany" placeholder="Empresa" class="border p-2 rounded" />
          <input id="contactPhone" placeholder="Telefone" class="border p-2 rounded" />
          <input id="contactEmail" placeholder="Email" class="border p-2 rounded" />
          <input id="contactAddr" placeholder="Endereço (texto)" class="border p-2 rounded md:col-span-2" />
          <input id="contactNotes" placeholder="Observações / links extras (separar por vírgula)" class="border p-2 rounded md:col-span-2" />
          <div class="md:col-span-2 text-xs text-gray-500">O botão "Salvar contato" gera um arquivo .vcf com todos esses dados e os links que você adicionar.</div>
        </div>

        <!-- Serviços -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <h2 class="font-medium">Serviços</h2>
            <button id="addService" class="px-3 py-1 border rounded text-sm">+ Adicionar serviço</button>
          </div>
          <div id="servicesList" class="space-y-4"></div>
          <div class="text-xs text-gray-500 mt-2">Cada serviço permite até 3 imagens (carrossel), título, descrição e valor.</div>
        </div>

        <!-- Ações -->
        <div class="flex gap-2">
          <button id="btnExportJSON" class="px-4 py-2 border rounded">Exportar JSON</button>
          <button id="btnCopyLink" class="px-4 py-2 border rounded">Copiar link público</button>
          <button id="btnDelete" class="px-4 py-2 border rounded text-red-600">Excluir cartão</button>
        </div>
        <div id="status" class="text-sm text-gray-500"></div>
      </div>
    </div>

    <!-- PREVIEW / LISTA -->
    <div class="bg-white p-6 rounded-xl shadow">
      <div class="flex items-center justify-between mb-4">
        <h2 class="font-semibold">Preview</h2>
        <div class="text-xs text-gray-400">Visual público / mobile</div>
      </div>

      <div id="publicPreview" class="card-preview mx-auto rounded-xl overflow-hidden border" style="border-width:6px; border-color:#6b21a8;">
        <div id="previewWrapper" style="position:relative;">
          <!-- background image -->
          <div id="bgLayer" style="position:absolute;inset:0;background-size:cover;background-position:center;opacity:0.25;z-index:0;border-radius:8px;"></div>
          <div style="position:relative;z-index:1;padding:18px;background:transparent;">
            <div class="flex justify-center mb-3">
              <div id="logoHolder" class="w-28 h-28 rounded-circle overflow-hidden bg-white flex items-center justify-center" style="border:6px solid #fff;">
                <img id="logoImg" src="" alt="" style="width:100%;height:100%;object-fit:cover;display:none;">
                <div id="logoPlaceholder" class="text-xs text-gray-400">Logo</div>
              </div>
            </div>

            <div class="bg-gray-800/60 p-4 rounded-lg" id="buttonsArea" style="backdrop-filter: blur(4px);">
              <!-- buttons will be inserted here -->
            </div>

            <div class="mt-4 bg-gray-100 p-3 rounded">
              <div id="previewContact" class="text-sm text-gray-700"></div>
            </div>

            <div class="mt-4" id="servicesArea"></div>

            <div class="mt-4 text-center text-xs text-gray-500">Toque para abrir / ações</div>

          </div>
        </div>
        <div class="p-3 bg-gray-50 border-t text-xs text-center">Link público: <span id="publicUrl" class="break-all"></span></div>
      </div>

      <div id="listArea" class="mt-4"></div>
    </div>

  </div>

  <!-- FIREBASE -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js";

    // ---------- CONFIG: seu firebase (já preenchido com as suas credenciais) --------------
    const firebaseConfig = {
      apiKey: "AIzaSyCAypo0N8sNBm80aRdxVOtmuivfDTrt294",
      authDomain: "fivestar-da5ec.firebaseapp.com",
      projectId: "fivestar-da5ec",
      storageBucket: "fivestar-da5ec.appspot.com",
      messagingSenderId: "431494326996",
      appId: "1:431494326996:web:64e1283fef158b1acc6941",
      measurementId: "G-CEHTL22LBW"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- helpers DOM ----------
    const cardIdInput = document.getElementById('cardId');
    const btnOpen = document.getElementById('btnOpen');
    const btnList = document.getElementById('btnList');
    const editorUI = document.getElementById('editorUI');
    const status = document.getElementById('status');
    let currentId = null;
    let unsubscribeDoc = null;
    let saveTimer = null;

    // editor elements
    const bgFile = document.getElementById('bgFile');
    const bgOpacity = document.getElementById('bgOpacity');
    const bgOpacityVal = document.getElementById('bgOpacityVal');
    const logoFile = document.getElementById('logoFile');
    const logoPreview = document.getElementById('logoPreview');
    const logoImg = document.getElementById('logoImg');
    const logoPlaceholder = document.getElementById('logoPlaceholder');

    const contactName = document.getElementById('contactName');
    const contactCompany = document.getElementById('contactCompany');
    const contactPhone = document.getElementById('contactPhone');
    const contactEmail = document.getElementById('contactEmail');
    const contactAddr = document.getElementById('contactAddr');
    const contactNotes = document.getElementById('contactNotes');

    const addBtn = document.getElementById('addBtn');
    const buttonsList = document.getElementById('buttonsList');

    const addService = document.getElementById('addService');
    const servicesList = document.getElementById('servicesList');

    const btnExportJSON = document.getElementById('btnExportJSON');
    const btnCopyLink = document.getElementById('btnCopyLink');
    const btnDelete = document.getElementById('btnDelete');

    const bgLayer = document.getElementById('bgLayer');
    const logoHolder = document.getElementById('logoHolder');
    const buttonsArea = document.getElementById('buttonsArea');
    const previewContact = document.getElementById('previewContact');
    const servicesArea = document.getElementById('servicesArea');
    const publicUrlSpan = document.getElementById('publicUrl');
    const listArea = document.getElementById('listArea');

    // default demo images (usando os arquivos que você enviou como exemplo)
    const demoBg = "file:///mnt/data/9ae7e4a0-b74b-495d-8fba-f0d09b90cbb3.png";
    const demoServiceImg = "file:///mnt/data/bd893be6-14cc-430c-b01e-ce013be9774a.png";

    // ---------- estado local ----------
    let state = {
      background: { url: demoBg, opacity: 0.25 },
      logoUrl: "",
      buttons: [
        // { iconUrl:'', text:'PIX', link:'pix://..' }
      ],
      contact: { name:'', company:'', phone:'', email:'', addr:'', notes:'' },
      services: [
        // { title:'', desc:'', images:[], price:'' }
      ],
      updated: new Date().toISOString()
    };

    // ---------- utilidades ----------
    function enableEditor(enable=true){
      editorUI.classList.toggle('opacity-50', !enable);
      editorUI.classList.toggle('pointer-events-none', !enable);
    }

    function scheduleSave(){
      status.innerText = 'Alteração pendente...';
      if (saveTimer) clearTimeout(saveTimer);
      saveTimer = setTimeout(()=> saveCurrent(), 800);
    }

    function dataToPayload(){
      state.updated = new Date().toISOString();
      return state;
    }

    // ---------- create dynamic UI elements ----------
    function renderButtonsEditor(){
      buttonsList.innerHTML = '';
      state.buttons.forEach((b, idx) => {
        const div = document.createElement('div');
        div.className = 'flex gap-2 items-center';
        div.innerHTML = `
          <input data-idx="${idx}" data-type="icon" type="file" accept="image/*" class="border p-1 rounded w-20" />
          <input data-idx="${idx}" data-type="text" class="border p-2 rounded flex-1" value="${b.text||''}" placeholder="Texto" />
          <input data-idx="${idx}" data-type="link" class="border p-2 rounded w-48" value="${b.link||''}" placeholder="https://..." />
          <button data-idx="${idx}" class="px-2 py-1 border rounded text-sm text-red-600">Apagar</button>
        `;
        buttonsList.appendChild(div);

        // attach listeners
        const fileInput = div.querySelector('input[data-type="icon"]');
        const textInput = div.querySelector('input[data-type="text"]');
        const linkInput = div.querySelector('input[data-type="link"]');
        const delBtn = div.querySelector('button');

        fileInput.addEventListener('change', async (e) => {
          const f = e.target.files[0];
          if (!f) return;
          const rdr = new FileReader();
          rdr.onload = async () => {
            // upload to storage
            const key = `cards/${currentId}/buttons/icon_${idx}.png`;
            const storageRef = sRef(storage, key);
            await uploadString(storageRef, rdr.result, 'data_url');
            const url = await getDownloadURL(storageRef);
            state.buttons[idx].iconUrl = url;
            renderPreview();
            scheduleSave();
          };
          rdr.readAsDataURL(f);
        });
        textInput.addEventListener('input', (e) => {
          state.buttons[idx].text = e.target.value;
          renderPreview();
          scheduleSave();
        });
        linkInput.addEventListener('input', (e) => {
          state.buttons[idx].link = e.target.value;
          scheduleSave();
        });
        delBtn.addEventListener('click', () => {
          state.buttons.splice(idx,1);
          renderButtonsEditor();
          renderPreview();
          scheduleSave();
        });
      });
    }

    function renderServicesEditor(){
      servicesList.innerHTML = '';
      state.services.forEach((s, sidx) => {
        const container = document.createElement('div');
        container.className = 'p-3 border rounded';
        container.innerHTML = `
          <div class="flex justify-between items-center mb-2">
            <strong>Serviço ${sidx+1}</strong>
            <button data-sidx="${sidx}" class="px-2 py-1 border rounded text-sm text-red-600">Remover</button>
          </div>
          <input data-sidx="${sidx}" data-type="title" placeholder="Título do serviço" class="border p-2 rounded w-full mb-2" value="${s.title||''}" />
          <textarea data-sidx="${sidx}" data-type="desc" placeholder="Descrição" class="border p-2 rounded w-full mb-2">${s.desc||''}</textarea>
          <div class="flex gap-2 items-center mb-2">
            <input data-sidx="${sidx}" data-type="price" placeholder="Valor (R$)" class="border p-2 rounded w-40" value="${s.price||''}" />
            <input data-sidx="${sidx}" data-type="img" type="file" accept="image/*" class="border p-1 rounded flex-1" />
            <div class="text-xs text-gray-500">Máx 3 imagens</div>
          </div>
          <div class="flex gap-2" id="thumbs-${sidx}"></div>
        `;
        servicesList.appendChild(container);

        // attach listeners
        container.querySelector(`[data-type="title"]`).addEventListener('input', (e)=> { state.services[sidx].title = e.target.value; renderPreview(); scheduleSave(); });
        container.querySelector(`[data-type="desc"]`).addEventListener('input', (e)=> { state.services[sidx].desc = e.target.value; renderPreview(); scheduleSave(); });
        container.querySelector(`[data-type="price"]`).addEventListener('input', (e)=> { state.services[sidx].price = e.target.value; scheduleSave(); renderPreview(); });
        container.querySelector(`[data-type="img"]`).addEventListener('change', async (e)=> {
          const f = e.target.files[0];
          if (!f) return;
          if (!state.services[sidx].images) state.services[sidx].images = [];
          if (state.services[sidx].images.length >= 3) return alert('Máximo 3 imagens por serviço');
          const rdr = new FileReader();
          rdr.onload = async () => {
            const key = `cards/${currentId}/services/s${sidx}_img${state.services[sidx].images.length}.png`;
            const storageRef = sRef(storage, key);
            await uploadString(storageRef, rdr.result, 'data_url');
            const url = await getDownloadURL(storageRef);
            state.services[sidx].images.push(url);
            renderServicesEditor();
            renderPreview();
            scheduleSave();
          };
          rdr.readAsDataURL(f);
        });

        container.querySelector('button').addEventListener('click', ()=> {
          state.services.splice(sidx,1);
          renderServicesEditor();
          renderPreview();
          scheduleSave();
        });

        // thumbs
        const thumbs = container.querySelector(`#thumbs-${sidx}`);
        thumbs.innerHTML = '';
        (s.images || []).forEach((imgUrl, idx) => {
          const img = document.createElement('div');
          img.className = 'w-20 h-20 rounded overflow-hidden border';
          img.innerHTML = `<img src="${imgUrl}" style="width:100%;height:100%;object-fit:cover;">`;
          const del = document.createElement('button');
          del.className = 'text-xs text-red-600 ml-2';
          del.textContent = 'X';
          del.addEventListener('click', async ()=> {
            // try delete from storage? (optional)
            state.services[sidx].images.splice(idx,1);
            renderServicesEditor();
            renderPreview();
            scheduleSave();
          });
          thumbs.appendChild(img);
          thumbs.appendChild(del);
        });
      });
    }

    // ---------- render preview public ----------
    function renderPreview(){
      // background + opacity
      bgLayer.style.backgroundImage = `url('${state.background.url || demoBg}')`;
      bgLayer.style.opacity = state.background.opacity ?? 0.25;
      bgOpacity.value = state.background.opacity ?? 0.25;
      bgOpacityVal.textContent = (state.background.opacity ?? 0.25);

      // logo
      if (state.logoUrl) {
        logoImg.src = state.logoUrl; logoImg.style.display='block'; logoPlaceholder.style.display='none';
      } else { logoImg.style.display='none'; logoPlaceholder.style.display='block'; }

      // buttons
      buttonsArea.innerHTML = '';
      (state.buttons||[]).forEach(b=>{
        const a = document.createElement('a');
        a.className = 'flex items-center gap-3 p-2 rounded-lg bg-white/80 mb-2';
        a.href = b.link||'#';
        a.target = '_blank';
        a.innerHTML = `${b.iconUrl ? '<img src="'+b.iconUrl+'" class="small-icon">' : ''}<span class="text-sm font-medium">${b.text||'Botão'}</span>`;
        buttonsArea.appendChild(a);
      });

      // contact
      previewContact.innerHTML = `<div class="font-medium">${state.contact.name||''}</div>
        <div class="text-xs text-gray-600">${state.contact.company||''}</div>
        <div class="mt-2 text-sm"><strong>Tel:</strong> ${state.contact.phone||'-'}</div>
        <div class="text-sm"><strong>Email:</strong> ${state.contact.email||'-'}</div>
        <div class="text-sm"><strong>End:</strong> ${state.contact.addr||'-'}</div>`;

      // services
      servicesArea.innerHTML = '';
      (state.services || []).forEach((s, idx) => {
        const box = document.createElement('div');
        box.className = 'mt-3 p-3 bg-gray-200 rounded';
        box.innerHTML = `<div class="font-semibold">${s.title||'Título'}</div>
                         <div class="text-xs text-gray-700 my-2">${s.desc||''}</div>
                         <div style="display:flex;gap:8px;">${(s.images||[]).map(img=>`<div class="service-slide"><img src="${img}" style="max-width:100%;max-height:100%;object-fit:cover;border-radius:8px;"></div>`).join('') || `<div class="service-slide">${demoServiceImg?'<img src="'+demoServiceImg+'" style="max-width:100%;max-height:100%;object-fit:cover;border-radius:8px;">':'Sem imagens'}</div>`}
                         </div>
                         <div class="mt-2 font-medium">Valor: R$ ${s.price||'--'}</div>`;
        servicesArea.appendChild(box);
      });

      renderPublicUrl();
    }

    // ---------- save/load ----------
    async function saveCurrent(){
      if (!currentId) return;
      try {
        const payload = dataToPayload();
        await setDoc(doc(db,'cards', currentId), payload, { merge:true });
        status.innerText = 'Salvo.';
      } catch (err) {
        status.innerText = 'Erro ao salvar: ' + err.message;
      }
    }

    async function loadCard(id){
      if (!id) return alert('Informe ID do cartão');
      currentId = id;
      enableEditor(false);
      status.innerText = 'Carregando...';
      // unsubscribe prev
      if (unsubscribeDoc) unsubscribeDoc();
      const ref = doc(db,'cards', id);
      unsubscribeDoc = onSnapshot(ref, (snap)=>{
        if (!snap.exists()){
          // create base
          state = {
            background: { url: demoBg, opacity:0.25 },
            logoUrl: '',
            buttons: [],
            contact: { name:'', company:'', phone:'', email:'', addr:'', notes:'' },
            services: [],
            updated: new Date().toISOString()
          };
          setDoc(ref, state, { merge:true });
          renderButtonsEditor(); renderServicesEditor(); renderPreview();
          enableEditor(true);
          status.innerText = 'Cartão criado (ID: '+id+')';
          return;
        }
        state = snap.data();
        if (!state.background) state.background = { url: demoBg, opacity:0.25 };
        if (!state.services) state.services = [];
        if (!state.buttons) state.buttons = [];
        // fill editor fields
        contactName.value = state.contact.name||'';
        contactCompany.value = state.contact.company||'';
        contactPhone.value = state.contact.phone||'';
        contactEmail.value = state.contact.email||'';
        contactAddr.value = state.contact.addr||'';
        contactNotes.value = state.contact.notes||'';
        bgLayer.style.backgroundImage = `url('${state.background.url}')`;
        bgLayer.style.opacity = state.background.opacity ?? 0.25;
        logoImg.src = state.logoUrl||'';
        renderButtonsEditor();
        renderServicesEditor();
        renderPreview();
        enableEditor(true);
        status.innerText = 'Dados carregados. Última atualização: '+(state.updated||'-');
      }, (err)=> {
        console.error(err); status.innerText='Erro: '+err.message;
      });
    }

    // ---------- UI events ----------
    btnOpen.addEventListener('click', ()=> {
      const id = cardIdInput.value.trim();
      if (!id) return alert('Digite o ID do cartão');
      loadCard(id);
    });

    btnList.addEventListener('click', async ()=> {
      listArea.innerHTML = 'Carregando...';
      const snap = await getDocs(collection(db,'cards'));
      if (snap.empty) { listArea.innerHTML = '<div class="text-sm text-gray-500">Nenhum cartão</div>'; return; }
      const rows = [];
      snap.forEach(d => {
        const data = d.data();
        rows.push(`<div class="p-2 border-b flex justify-between items-center">
          <div>
            <div class="font-medium text-sm">${data.contact?.name||d.id}</div>
            <div class="text-xs text-gray-500">${d.id} • ${data.updated?new Date(data.updated).toLocaleString():'-'}</div>
          </div>
          <div class="flex gap-2">
            <button onclick="window.loadFromList('${d.id}')" class="px-2 py-1 text-xs border rounded">Abrir</button>
            <button onclick="window.deleteCard('${d.id}')" class="px-2 py-1 text-xs border rounded text-red-600">Apagar</button>
          </div>
        </div>`);
      });
      listArea.innerHTML = rows.join('');
    });

    // logo upload
    logoFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      const rdr = new FileReader();
      rdr.onload = async () => {
        // upload to storage
        const key = `cards/${currentId||'temp'}/logo.png`;
        if (currentId) {
          const storageRef = sRef(storage, key);
          await uploadString(storageRef, rdr.result, 'data_url');
          const url = await getDownloadURL(storageRef);
          state.logoUrl = url;
        } else {
          state.logoUrl = rdr.result; // temp until saved
        }
        logoPreview.innerHTML = `<img src="${state.logoUrl}" style="width:100%;height:100%;object-fit:cover;">`;
        renderPreview();
        scheduleSave();
      };
      rdr.readAsDataURL(f);
    });

    // bg upload
    bgFile.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if (!f) return;
      const rdr = new FileReader();
      rdr.onload = async () => {
        const key = `cards/${currentId||'temp'}/bg.png`;
        if (currentId) {
          const storageRef = sRef(storage,key);
          await uploadString(storageRef, rdr.result, 'data_url');
          const url = await getDownloadURL(storageRef);
          state.background.url = url;
        } else {
          state.background.url = rdr.result;
        }
        renderPreview();
        scheduleSave();
      };
      rdr.readAsDataURL(f);
    });
    bgOpacity.addEventListener('input', (e)=>{
      state.background.opacity = Number(e.target.value);
      bgOpacityVal.textContent = state.background.opacity;
      renderPreview();
      scheduleSave();
    });

    // contact inputs
    [contactName, contactCompany, contactPhone, contactEmail, contactAddr, contactNotes].forEach(inp=>{
      inp.addEventListener('input', (e)=> {
        const key = e.target.id.replace('contact','').toLowerCase();
        // map manually
        state.contact.name = contactName.value;
        state.contact.company = contactCompany.value;
        state.contact.phone = contactPhone.value;
        state.contact.email = contactEmail.value;
        state.contact.addr = contactAddr.value;
        state.contact.notes = contactNotes.value;
        renderPreview();
        scheduleSave();
      });
    });

    // buttons add
    addBtn.addEventListener('click', ()=> {
      state.buttons.push({ iconUrl:'', text:'Novo botão', link:'' });
      renderButtonsEditor(); renderPreview(); scheduleSave();
    });

    // add service
    addService.addEventListener('click', ()=> {
      state.services.push({ title:'Serviço', desc:'Descrição', images:[], price:'' });
      renderServicesEditor(); renderPreview(); scheduleSave();
    });

    // export JSON
    btnExportJSON.addEventListener('click', ()=> {
      if (!currentId) return alert('Abra um cartão primeiro');
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(state,null,2));
      const a = document.createElement('a'); a.href = dataStr; a.download = currentId+".json"; a.click();
    });

    // copy link
    btnCopyLink.addEventListener('click', ()=> {
      if (!currentId) return alert('Abra um cartão primeiro');
      const url = `${location.origin}${location.pathname}?id=${encodeURIComponent(currentId)}&public=1`;
      navigator.clipboard.writeText(url).then(()=> alert('Link público copiado'));
    });

    // delete card
    btnDelete.addEventListener('click', async ()=> {
      if (!currentId) return alert('Abra um cartão primeiro');
      if (!confirm('Excluir cartão '+currentId+' ?')) return;
      await deleteDoc(doc(db,'cards',currentId));
      status.innerText='Cartão excluído';
      currentId = null;
      enableEditor(false);
    });

    // helper for list buttons
    window.loadFromList = (id)=> loadCard(id);
    window.deleteCard = async (id)=> { if(confirm('Excluir '+id+'?')) { await deleteDoc(doc(db,'cards',id)); document.getElementById('btnList').click(); } };

    // ---------- public view logic on page load ----------
    (function handleOnLoad(){
      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      const isPublic = params.get('public') === '1';
      if (!id) { enableEditor(false); return; }
      if (isPublic) {
        // render minimal public view
        (async ()=>{
          const snap = await getDoc(doc(db,'cards',id));
          if (!snap.exists()) { document.body.innerHTML = '<div class="p-6">Cartão não encontrado</div>'; return; }
          const d = snap.data();
          // small public html
          document.body.innerHTML = `
            <div class="min-h-screen bg-gray-50 p-6 flex items-center justify-center">
              <div class="w-full max-w-sm bg-white p-6 rounded-xl shadow text-center">
                <div style="border:6px solid ${d.background?.color||'#6b21a8'}" class="rounded-xl overflow-hidden">
                  <div class="p-4">
                    <div class="w-24 h-24 rounded-full mx-auto overflow-hidden bg-gray-100">${d.logoUrl?'<img src="'+d.logoUrl+'" class="w-full h-full object-cover">':''}</div>
                    <h2 class="mt-4 text-xl font-semibold">${d.contact?.name||''}</h2>
                    <div class="text-sm text-gray-600">${d.contact?.company||''}</div>
                    <div class="mt-4 text-sm text-gray-700">
                      <div><strong>Tel:</strong> ${d.contact?.phone||'-'}</div>
                      <div><strong>Email:</strong> ${d.contact?.email||'-'}</div>
                      <div><strong>End:</strong> ${d.contact?.addr||'-'}</div>
                    </div>
                    <p class="mt-4 text-sm text-gray-600">${d.services?.length? d.services.map(s=>`<div style="margin-bottom:12px"><strong>${s.title}</strong><div>${s.desc}</div><div>Valor: R$ ${s.price||'--'}</div></div>`).join('') : '' }</p>
                    <div class="mt-4">
                      ${ (d.buttons||[]).map(b=> `<a href="${b.link||'#'}" class="px-3 py-2 border rounded mx-1 inline-block" target="_blank">${b.text||'Abrir'}</a>`).join('') }
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        })();
        return;
      }
      // else load editor for this id
      loadCard(id);
    })();

    // initial render
    renderPreview();

    // ---------- VCF generator for "Salvar contato" (public) ----------
    // We'll attach a handler on preview area: when user clicks a button with text "Salvar Contato", it will generate and download vcf.
    // Since buttons are dynamic, we handle clicks at container level.
    buttonsArea.addEventListener('click', (e) => {
      const a = e.target.closest('a');
      if (!a) return;
      const txt = a.innerText.trim().toLowerCase();
      if (txt.includes('salvar') || txt.includes('contato')) {
        generateVCF();
        e.preventDefault();
      }
    });

    async function generateVCF(){
      const v = state.contact || {};
      // Build VCard 3.0
      const lines = [
        'BEGIN:VCARD',
        'VERSION:3.0',
        `FN:${v.name || ''}`,
        `ORG:${v.company || ''}`,
        `TEL;TYPE=CELL:${v.phone || ''}`,
        `EMAIL;TYPE=INTERNET:${v.email || ''}`,
        `ADR;TYPE=HOME:;;${v.addr||''};;;;`,
      ];
      // add notes and links (notes field)
      if (v.notes) lines.push(`NOTE:${v.notes}`);
      // add button links into URL fields
      (state.buttons||[]).forEach((b, idx)=>{
        if (b.link) lines.push(`URL;TYPE=other:${b.link}`);
      });
      lines.push('END:VCARD');
      const blob = new Blob([lines.join('\r\n')], { type: 'text/vcard' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = (v.name||'contato') + '.vcf'; a.click();
      URL.revokeObjectURL(url);
    }

  </script>
</body>
</html>
